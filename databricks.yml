# Configuration file for **Databricks Asset Bundles (DAB)**, which is the modern approach for deploying and managing Databricks resources

bundle:
  name: "data_pipeline_bundle"

targets:
  dev_feature:
    mode: development
    workspace:
      # `${bundle.name}`: `data_pipeline`, `${bundle.target}`: `dev_feature`
      root_path: "~/.bundle/${bundle.name}/${bundle.target}" 
    
    resources:
      jobs:
        data-pipeline:
          name: "data_pipeline_master"
          tasks:
          # Dataset Generation --------------------
            - task_key: "data_generation_task"
              environment_key: "serverless_env"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.data_generation.task.generate_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"

          # Data ETL Pipeline --------------------
            # Contact Info: Raw zone processes
            - task_key: "ci_dev_feature_task_raw"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "data_generation_task"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.contact_info.task.raw.ci_extract_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--pipeline"
                  - "contact_info"
            # Contact Info: Bronze zone processes
            - task_key: "ci_dev_feature_task_bronze"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "ci_dev_feature_task_raw"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.contact_info.task.bronze.ci_transform_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--pipeline"
                  - "contact_info"
            # Contact Info: Silver zone processes
            - task_key: "ci_dev_feature_task_silver"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "ci_dev_feature_task_bronze"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.contact_info.task.silver.ci_load_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--pipeline"
                  - "contact_info"

            # Real Estate: Raw zone processes
            - task_key: "re_dev_feature_task_raw"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "ci_dev_feature_task_silver"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.real_estate.task.raw.re_extract_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--pipeline"
                  - "real_estate"
            # Real Estate: Bronze zone processes
            - task_key: "re_dev_feature_task_bronze"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "re_dev_feature_task_raw"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.real_estate.task.bronze.re_transform_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--pipeline"
                  - "real_estate"
            # Real Estate: Silver zone processes
            - task_key: "re_dev_feature_task_silver"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "re_dev_feature_task_bronze"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.real_estate.task.silver.re_load_data_task"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--pipeline"
                  - "real_estate"

          # QA Validation Pipeline --------------------
            - task_key: "cip_dev_feature_validation_task"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "re_dev_feature_task_silver"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.validation.task.cip_val"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--object_type"
                  - "ci"
                  - "--job_type"
                  - "cip"
                  - "--test_type"
                  - "smoke"

            - task_key: "rep_dev_feature_validation_task"
              environment_key: "serverless_env"
              depends_on:
                - task_key: "cip_dev_feature_validation_task"
              python_wheel_task:
                package_name: "data_pipeline"
                entry_point: "data-pipeline-etl"
                parameters:
                  - "data_pipeline.validation.task.rep_val"
                  - "--env"
                  - "dev"
                  - "--space"
                  - "feature"
                  - "--object_type"
                  - "re"
                  - "--job_type"
                  - "rep"
                  - "--test_type"
                  - "smoke"
          
          # Serverless environment config (serverless, libraries go in environments.spec.dependencies)
          environments:
            - environment_key: "serverless_env"
              spec:
                client: "1"  # Required for serverless compute
                dependencies:
                  - ./dist/*.whl  # Wheel library specified here for serverless
          timeout_seconds: 3600